/*
 * Copyright (c) 2025. Author: Ruslan Bikchentaev. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 * Перший приватний програміст.
 */

// Code generated by qtc from "table-row.js.qtpl". DO NOT EDIT.
// See https://github.com/valyala/quicktemplate for details.

//line table-row.js.qtpl:1
package js

//line table-row.js.qtpl:1
import (
	qtio422016 "io"

	qt422016 "github.com/valyala/quicktemplate"
)

//line table-row.js.qtpl:1
var (
	_ = qtio422016.Copy
	_ = qt422016.AcquireByteBuffer
)

//line table-row.js.qtpl:1
func StreamTableJS(qw422016 *qt422016.Writer) {
//line table-row.js.qtpl:1
	qw422016.N().S(`
 `)
//line table-row.js.qtpl:2
	qw422016.N().S(`/*
 * Copyright (c) 2023-2025. Author: Ruslan Bikchentaev. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 * Перший приватний програміст. 
 */
"use strict";

function ClickPseudo(event) {
    var elem = event.target;
    var offset = event.clientX || event.originalEvent.clientX;
    console.log(event);
    console.log(`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`${offset} > ${elem.offsetLeft}, ${elem.getBoundingClientRect().left}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`);
    // clear other sorted
    if (!event.altKey) {
        $('.sorted-desc').removeClass('sorted-desc');
        $('.sorted-asc').removeClass('sorted-asc');
    }

    if (offset > elem.getBoundingClientRect().left + 20) {
        $(elem).removeClass('sorted-desc').addClass('sorted-asc');
    } else {
        $(elem).removeClass('sorted-asc').addClass('sorted-desc');
    }

    loadTableWithOrder();
}

const reqOffset = /(order_by=)([^&]+(%20desc)?,?)+/;

function getOrderByStatus(url) {
    return reqOffset.exec(url)
}

const selTablesRows = '.usr-table-row-cont';

// reorder data & get new table content
function loadTableWithOrder() {
    let orderBy = $('.usr-table__t-head .usr-table-col')
        .children('span.sorted-asc,span.sorted-desc')
        .map(function () {
            return $(this).attr('column') + (this.className === 'sorted-desc' ? '%20desc' : '');
        }).get().join(",");

    console.log(orderBy)

    var url = document.location.href;
    const parts = getOrderByStatus(url);

    if (!parts || parts.length <= 0) {
        url += (document.location.search > "" ? '&' : '?') + `)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`order_by=${orderBy}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`
    } else if (orderBy === parts[2]) {
        console.log(parts)
        return false;
    } else {
        url = url.replace(reqOffset, `)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`$1${orderBy}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`);
        console.log(url)
    }

    $.ajaxSetup({
        beforeSend: getHeaders,
    });
    // load only table rows content
    $(selTablesRows).load(url + ' .usr-table-row-cont');

    return setHashFromTable(url)
}

// set hash with all data of table
function setHashFromTable(url) {
    SetDocumentHash(url, $('.usr-table').html());
    return true;
}

// append data over limit into table content
function appendTable() {
    let tableCnt = $('.usr-table-content');
    var tableRows = $(selTablesRows);
    var lines = tableRows.children('div:visible').length;
    let url = new URL(window.location.href);
    let params = new URLSearchParams(url.search);

    params.set("offset", `)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`${lines}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`);
    // const reqLimit = /(offset=)(\d+)/;
    // const parts = reqLimit.exec(url);
    // if (!parts || parts.length < 1) {
    //     url += (document.location.search > "" ? '&' : '?') + `)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`offset=${lines}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`
    // } else if (lines === parseInt(parts[1])) {
    //     return false;
    // } else {
    //     url = url.replace(reqLimit, `)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`$1${lines}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`);
    // }
    $('div.filt-arrow > input, div.filt-arrow > select').each(
        (i, elem) => {
            if (elem.value) {
                let value = elem.value;
                if (elem.type === 'checkbox') {
                    if (!elem.checked) {
                        return
                    }
                    value = true
                }
                params.set(elem.dataset.name, value);
                // var reqDataSet = new RegExp(`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`(${elem.dataset.name}=)(\[^&]+)`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`);
                // if (!reqDataSet.test(url)) {
                //     url += `)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`&${elem.dataset.name}=${value}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`;
                // } else {
                //     url = url.replace(reqDataSet, `)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`$1${value}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`);
                // }
            }
        });

    let newURL = url.origin + url.pathname + "?" + params.toString();
    $.ajax({
        url: newURL,
        data: {
            "html": true
        },
        processData: false,
        contentType: false,
        beforeSend: getHeaders,
        success: function (data, status, xhr) {
            if (xhr.status === 204) {
                tableCnt.off('mousewheel');
                tableRows.html(data);
                return false;
            }
            tableRows.append($('<div />').html(data).find(selTablesRows).html());
            setHashFromTable(newURL);
        },
        error: function (xhr, status, error) {
            if (xhr.status === 401) {
                urlAfterLogin = newURL;
                $('#bLogin').trigger("click");
                return;
            }

            alert("Code : " + xhr.status + ", " + error + ": " + xhr.responseText);
            console.log(xhr);
        }
    });
    return true;
}

function filterTableData(value, className) {
    let val = value.trim();
    if (val === "") {
        $('.usr-table-row-cont .usr-table-row').show();
        return true;
    }

    let dateRanges = val.match(/\[(\d+-\d+-\d+),(\d+-\d+-\d+)\]/);
    if (!dateRanges) {
        var numberRanges = val.match(/[[)](\d+.?\d*),(\d+.?\d*)[\])]/);
    }
    if (!dateRanges && !numberRanges) {
        var strSlices = val.match(/(\w),(\w+)/);
        console.log(strSlices);
    }
    let i = 0;
    var items = document.getElementsByClassName(className);
    // filter rows according to input text/value
    Array.prototype.slice.call(items).forEach(
        (el, ind, arr) => {
            let textContent = el.textContent;
            if (textContent.includes(val)
                || (dateRanges && (dateRanges.length > 1) && textContent >= dateRanges[1] && textContent <= dateRanges[2])
                || (numberRanges && (numberRanges.length > 1) && textContent >= numberRanges[1] && textContent <= numberRanges[2])
                || (strSlices && (strSlices.length > 1) && textContent >= strSlices[1] && textContent <= strSlices[2])
                || el.parentElement.className.includes("usr-table__t-head")
                || el.parentElement.className.includes("usr-table__filter")) {
                $(el).removeClass('unfilter');
                i++
                return true;
            }
            $(el).addClass('unfilter');
            return true;
        });

    $('.usr-table-row').each((ind, elem) => {
        if ($(elem).children('.usr-table-col.unfilter').length > 0) {
            $(elem).hide();
        } else {
            $(elem).show();
        }
    })
    // append data if we filter has counter of lines less than page
    if (i < GetPageLines()) {
        appendTable();
    }
}

function ScrollToElem(selector) {
    var list = $(selector);
    if (list.length > 0) {
        list[0].scrollIntoView(100);
    } else {
        alert(selector + ' not found!');
    }
    return true;
}

function SetTableEvents() {
    $('.usr-table__t-head .usr-table-col span').click(ClickPseudo);
    setSortedClasses();

    let tableCnt = $('.usr-table-content');
    tableCnt.off('mousewheel');
    if ($(selTablesRows + '> div.usr-table-row:visible').length < GetPageLines()) {
        return
    }

    var throttleTimer;
    const throttle = (callback, time) => {
        if (throttleTimer) return;
        throttleTimer = true;
        callback();
        setTimeout(() => {
            throttleTimer = false;
        }, time);

    };
    tableCnt.on('mousewheel', function (event, delta) {
        var elem = event.target;
        console.log(event)
        if (elem !== event.currentTarget && isScrollableY(elem)) {
            console.log(elem);
            console.log(`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`${elem.clientHeight} < ${elem.scrollHeight}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`);
            return true;
        }

        if ((event.deltaY < 0) && tableCnt.scrollTop() + tableCnt.height() > Math.ceil(tableCnt[0].scrollHeight / 2)) {
            console.log(`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`${tableCnt.scrollTop() + tableCnt.height()} > ${Math.ceil(tableCnt[0].scrollHeight / 2)}`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`);
            throttle(appendTable, 300);
            return true;
        }
        return true;
    })
}

function setSortedClasses() {
    const parts = getOrderByStatus(document.location.href);
    if (parts && parts.length > 1) {
        for (const part of parts[2].split(',')) {
            console.log(part);
            const colName = part.split('%20');
            let sortedClass = 'sorted-asc';
            if (colName.length > 1) {
                sortedClass = 'sorted-desc';
            }
            $(`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`.usr-table__t-head .usr-table-col:nth-child(n+2) span[column=${colName[0]}]`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`).addClass(sortedClass);
        }
    }
}


function handleFileCSVSelect(evt) {
    var files = evt.files || evt.target.files; // FileList object
    if (files.length < 1)
        return false;

    let $progress = $('#progress').show(),
        reader = new FileReader(),
        f = files[0];

    reader.onload = (function (theFile) {
        return function (e) {
            let csv = e.target.result.csvToArray({head: true, rSep: "\n"});
            let fText = [];
            for (let elem of csv) {
                let row = '<div  class="usr-table-col  table-col-0">$</div>';
                if (elem.length === 1) {
                    elem = elem[0].split(';');
                }
                elem.forEach(function (cell, i) {
                    row += `)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`<div  class="usr-table-col  table-col-${i}">${cell}</div>`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`;
                });
                fText.push(`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`<div  class="usr-table-row">${row}</div>`)
//line table-row.js.qtpl:2
	qw422016.N().S("`")
//line table-row.js.qtpl:2
	qw422016.N().S(`);
                if (fText.length >= GetPageLines()) {
                    console.log(row);
                    break;
                }
            }

            $(selTablesRows).html(fText.join('\n'));
        };
    })(f);

    // Read in the image file as a data URL.
    reader.readAsText(f);
}
`)
//line table-row.js.qtpl:2
	qw422016.N().S(`
`)
//line table-row.js.qtpl:3
}

//line table-row.js.qtpl:3
func WriteTableJS(qq422016 qtio422016.Writer) {
//line table-row.js.qtpl:3
	qw422016 := qt422016.AcquireWriter(qq422016)
//line table-row.js.qtpl:3
	StreamTableJS(qw422016)
//line table-row.js.qtpl:3
	qt422016.ReleaseWriter(qw422016)
//line table-row.js.qtpl:3
}

//line table-row.js.qtpl:3
func TableJS() string {
//line table-row.js.qtpl:3
	qb422016 := qt422016.AcquireByteBuffer()
//line table-row.js.qtpl:3
	WriteTableJS(qb422016)
//line table-row.js.qtpl:3
	qs422016 := string(qb422016.B)
//line table-row.js.qtpl:3
	qt422016.ReleaseByteBuffer(qb422016)
//line table-row.js.qtpl:3
	return qs422016
//line table-row.js.qtpl:3
}
